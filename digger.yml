# By default, Digger does not run apply on merge.
# If you want to enable, uncomment the lines below and use 'apply-on-merge' workflow for projects.
# disable_digger_apply_comment: true
# disable_digger_apply_status_check: true

# Uncomment options below to automatically merge the PR when all checks pass (including successful apply)
# auto_merge: true
# auto_merge_strategy: "squash"
# Also read more about apply requirements: https://docs.opentaco.dev/ce/howto/apply-requirements

auto_merge: false
pr_locks: true
generate_projects:
  blocks:
    # teams/{team}/aws/test/{region}/{project}
    - include: "teams/*/*/test/*/*"
      exclude: "**/.terraform/**"
      terraform: true
      workflow: "default"
      # workflow: "with-checkov"
      # workflow: "with-infracost"
      # workflow: "prod"
    # teams/{team}/aws/prod/{region}/{project}
    - include: "teams/*/*/prod/*/*"
      exclude: "**/.terraform/**"
      terraform: true
      workflow: "prod"
    # infrastructure/{account_id}/{project}
    - include: "infrastructure/*/*"
      exclude: "**/.terraform/**"
      terraform: true
      # workflow: "default"
      # workflow: "with-checkov"
      # workflow: "with-infracost"
      workflow: "prod"

workflows:
  default:
    plan:
      steps:
        - init
        - plan
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  prod:
    env_vars:
      state:
        - name: TF_IN_AUTOMATION
          value: "true"
        - name: TF_INPUT
          value: "false"
      commands:
        - name: TF_IN_AUTOMATION
          value: "true"
        - name: TF_INPUT
          value: "false"
    plan:
      steps:
        - init
        - plan
        - run: checkov -d . --framework terraform
        - run: infracost breakdown --path=. | tee -a $DIGGER_OUT
        - run: |
            set -euo pipefail
            git fetch --no-tags origin "$DEFAULT_BRANCH"
            git checkout -B digger-base "origin/$DEFAULT_BRANCH"
            infracost breakdown --path . --format=json --out-file="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json"
            git fetch --no-tags origin "$PR_BRANCH"
            git checkout -B digger-pr FETCH_HEAD
        - run: infracost diff --path=. --compare-to="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json" | tee -a $DIGGER_OUT
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]

  with-checkov:
    env_vars:
      state:
        - name: TF_IN_AUTOMATION
          value: "true"
        - name: TF_INPUT
          value: "false"
      commands:
        - name: TF_IN_AUTOMATION
          value: "true"
        - name: TF_INPUT
          value: "false"
    plan:
      steps:
        - init
        - plan
        - run: checkov -d . --framework terraform
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]

  with-infracost:
    env_vars:
      state:
        - name: TF_IN_AUTOMATION
          value: "true"
        - name: TF_INPUT
          value: "false"
      commands:
        - name: TF_IN_AUTOMATION
          value: "true"
        - name: TF_INPUT
          value: "false"
    plan:
      steps:
        - init
        - plan
        - run: infracost breakdown --path=. | tee -a $DIGGER_OUT
        - run: |
            set -euo pipefail
            git fetch --no-tags origin "$DEFAULT_BRANCH"
            git checkout -B digger-base "origin/$DEFAULT_BRANCH"
            infracost breakdown --path . --format=json --out-file="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json"
            git fetch --no-tags origin "$PR_BRANCH"
            git checkout -B digger-pr FETCH_HEAD
        - run: infracost diff --path=. --compare-to="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json" | tee -a $DIGGER_OUT
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]

  apply-on-merge:
    env_vars:
      state:
        - name: TF_IN_AUTOMATION
          value: "true"
        - name: TF_INPUT
          value: "false"
      commands:
        - name: TF_IN_AUTOMATION
          value: "true"
        - name: TF_INPUT
          value: "false"
    plan:
      steps:
        - run: echo "TEST - starting plan step"
        - init
        - plan
    apply:
      steps:
        - run: echo "TEST - starting apply step"
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger apply"]
