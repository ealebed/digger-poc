# By default, Digger does not run apply on merge.
# If you want to enable, uncomment the lines below and use 'apply-on-merge' workflow for projects.
# disable_digger_apply_comment: true
# disable_digger_apply_status_check: true

# Uncomment options below to automatically merge the PR when all checks pass (including successful apply)
auto_merge: true
auto_merge_strategy: "squash"
# Also read more about apply requirements: https://docs.opentaco.dev/ce/howto/apply-requirements

# auto_merge: false
pr_locks: true
projects:
  - name: services_platform_notification_dev_eu-west-1
    dir: services/platform/notification
    apply_requirements: [approved, mergeable, undiverged]
    workflow: dev-eu-west-1
    aws_role_to_assume:
      state: "arn:aws:iam::531438381462:role/digger-notification-role"
      command: "arn:aws:iam::531438381462:role/digger-notification-role"
  - name: services_platform_notification_qa_eu-west-1
    dir: services/platform/notification
    apply_requirements: [approved, mergeable, undiverged]
    workflow: qa-eu-west-1
    aws_role_to_assume:
      state: "arn:aws:iam::531438381462:role/digger-notification-role"
      command: "arn:aws:iam::531438381462:role/digger-notification-role"
  - name: services_platform_notification_prod_eu-west-1
    dir: services/platform/notification
    apply_requirements: [approved, mergeable, undiverged]
    workflow: prod-eu-west-1
    aws_role_to_assume:
      state: "arn:aws:iam::531438381462:role/digger-notification-role"
      command: "arn:aws:iam::531438381462:role/digger-notification-role"
  - name: services_platform_notification_prod_us-east-1
    dir: services/platform/notification
    apply_requirements: [approved, mergeable, undiverged]
    workflow: prod-us-east-1
    aws_role_to_assume:
      state: "arn:aws:iam::531438381462:role/digger-notification-role"
      command: "arn:aws:iam::531438381462:role/digger-notification-role"

  - name: services_platform_security_dev_eu-west-1
    dir: services/platform/security
    apply_requirements: [approved, mergeable]
    workflow: dev-eu-west-1
    # aws_role_to_assume: "arn:aws:iam::123456789012:role/DiggerDevRole"
  - name: services_platform_security_prod_eu-west-1
    dir: services/platform/security
    apply_requirements: [approved, mergeable]
    workflow: prod-eu-west-1
    # aws_role_to_assume: "arn:aws:iam::531438381462:role/DiggerProdRole"

  - name: services_schedule_absence_dev_eu-west-1
    dir: services/schedule/absence
    workflow: dev-eu-west-1
    # aws_role_to_assume: "arn:aws:iam::123456789012:role/DiggerDevRole"
  - name: services_schedule_absence_qa_eu-west-1
    dir: services/schedule/absence
    workflow: qa-eu-west-1
    # aws_role_to_assume: "arn:aws:iam::123456789098:role/DiggerQaRole"


generate_projects:
  blocks:
    # teams/{team}/aws/test/{region}/{project}
    - include: "teams/*/*/test/*/*"
      exclude: "**/.terraform/**"
      terraform: true
      workflow: "default"
      # workflow: "with-checkov"
      # workflow: "with-infracost"
      # workflow: "prod"
    # teams/{team}/aws/prod/{region}/{project}
    - include: "teams/*/*/prod/*/*"
      exclude: "**/.terraform/**"
      terraform: true
      workflow: "prod"
    # infrastructure/{account_id}/{project}
    - include: "infrastructure/*/*"
      exclude: "**/.terraform/**"
      aws_role_to_assume:
        state: "arn:aws:iam::531438381462:role/digger-infra-role"
        command: "arn:aws:iam::531438381462:role/digger-infra-role"
      terraform: true
      # workflow: "default"
      # workflow: "with-checkov"
      # workflow: "with-infracost"
      workflow: "prod"

workflows:
  dev-eu-west-1:
    plan:
      steps:
        - run: |
            sed -e "s/ENV_NAME/dev/" -e "s/ENV_REGION/eu-west-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - plan:
          extra_args: ["-input=false", "-var-file=dev.eu.tfvars"]
    apply:
      steps:
        - run: |
            sed -e "s/ENV_NAME/dev/" -e "s/ENV_REGION/eu-west-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - apply:
          extra_args: ["-auto-approve", "-var-file=dev.eu.tfvars"]
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  dev-us-east-1:
    plan:
      steps:
        - run: |
            sed -e "s/ENV_NAME/dev/" -e "s/ENV_REGION/us-east-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - plan:
          extra_args: ["-input=false", "-var-file=dev.us.tfvars"]
    apply:
      steps:
        - run: |
            sed -e "s/ENV_NAME/dev/" -e "s/ENV_REGION/us-east-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - apply:
          extra_args: ["-auto-approve", "-var-file=dev.us.tfvars"]
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  qa-eu-west-1:
    plan:
      steps:
        - run: |
            sed -e "s/ENV_NAME/qa/" -e "s/ENV_REGION/eu-west-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - plan:
          extra_args: ["-input=false", "-var-file=qa.eu.tfvars"]
    apply:
      steps:
        - run: |
            sed -e "s/ENV_NAME/qa/" -e "s/ENV_REGION/eu-west-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - apply:
          extra_args: ["-auto-approve", "-var-file=qa.eu.tfvars"]
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  qa-us-east-1:
    plan:
      steps:
        - run: |
            sed -e "s/ENV_NAME/qa/" -e "s/ENV_REGION/us-east-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - plan:
          extra_args: ["-input=false", "-var-file=qa.us.tfvars"]
    apply:
      steps:
        - run: |
            sed -e "s/ENV_NAME/qa/" -e "s/ENV_REGION/us-east-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - apply:
          extra_args: ["-auto-approve", "-var-file=qa.us.tfvars"]
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  prod-eu-west-1:
    plan:
      steps:
        - run: |
            sed -e "s/ENV_NAME/prod/" -e "s/ENV_REGION/eu-west-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - plan:
          extra_args: ["-input=false", "-var-file=prod.eu.tfvars"]
        - run: checkov -d . --framework terraform
        - run: infracost breakdown --path=. | tee -a $DIGGER_OUT
        - run: |
            set -euo pipefail
            git fetch --no-tags origin "$DEFAULT_BRANCH"
            git checkout -B digger-base "origin/$DEFAULT_BRANCH"
            infracost breakdown --path . --format=json --out-file="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json"
            git fetch --no-tags origin "$PR_BRANCH"
            git checkout -B digger-pr FETCH_HEAD
        - run: infracost diff --path=. --compare-to="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json" | tee -a $DIGGER_OUT
    apply:
      steps:
        - run: |
            sed -e "s/ENV_NAME/prod/" -e "s/ENV_REGION/eu-west-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - apply:
          extra_args: ["-auto-approve", "-var-file=prod.eu.tfvars"]
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  prod-us-east-1:
    plan:
      steps:
        - run: |
            sed -e "s/ENV_NAME/prod/" -e "s/ENV_REGION/us-east-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - plan:
          extra_args: ["-input=false", "-var-file=prod.us.tfvars"]
        - run: checkov -d . --framework terraform
        - run: infracost breakdown --path=. | tee -a $DIGGER_OUT
        - run: |
            set -euo pipefail
            git fetch --no-tags origin "$DEFAULT_BRANCH"
            git checkout -B digger-base "origin/$DEFAULT_BRANCH"
            infracost breakdown --path . --format=json --out-file="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json"
            git fetch --no-tags origin "$PR_BRANCH"
            git checkout -B digger-pr FETCH_HEAD
        - run: infracost diff --path=. --compare-to="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json" | tee -a $DIGGER_OUT
    apply:
      steps:
        - run: |
            sed -e "s/ENV_NAME/prod/" -e "s/ENV_REGION/us-east-1/" < backend.tf.template > backend.tf
            cat backend.tf
        - init
        - apply:
          extra_args: ["-auto-approve", "-var-file=prod.us.tfvars"]
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  default:
    plan:
      steps:
        - init
        - plan
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  prod:
    plan:
      steps:
        - init
        - plan
        - run: checkov -d . --framework terraform
        - run: infracost breakdown --path=. | tee -a $DIGGER_OUT
        - run: |
            set -euo pipefail
            git fetch --no-tags origin "$DEFAULT_BRANCH"
            git checkout -B digger-base "origin/$DEFAULT_BRANCH"
            infracost breakdown --path . --format=json --out-file="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json"
            git fetch --no-tags origin "$PR_BRANCH"
            git checkout -B digger-pr FETCH_HEAD
        - run: infracost diff --path=. --compare-to="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json" | tee -a $DIGGER_OUT
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]

  with-checkov:
    plan:
      steps:
        - init
        - plan
        - run: checkov -d . --framework terraform
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]

  with-infracost:
    plan:
      steps:
        - init
        - plan
        - run: infracost breakdown --path=. | tee -a $DIGGER_OUT
        - run: |
            set -euo pipefail
            git fetch --no-tags origin "$DEFAULT_BRANCH"
            git checkout -B digger-base "origin/$DEFAULT_BRANCH"
            infracost breakdown --path . --format=json --out-file="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json"
            git fetch --no-tags origin "$PR_BRANCH"
            git checkout -B digger-pr FETCH_HEAD
        - run: infracost diff --path=. --compare-to="$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json" | tee -a $DIGGER_OUT
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]

  apply-on-merge:
    plan:
      steps:
        - init
        - plan
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger apply"]
