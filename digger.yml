auto_merge: false
pr_locks: true
generate_projects:
  blocks:
    # teams/{team}/aws/test/{region}/{project}
    - include: "teams/*/*/test/*/*"
      exclude: "**/.terraform/**"
      terraform: true
      # workflow: "default"
      workflow: "with-checkov"
    # teams/{team}/aws/prod/{region}/{project}
    - include: "teams/*/*/prod/*/*"
      exclude: "**/.terraform/**"
      terraform: true
      workflow: "prod"

workflows:
  default:
    plan:
      steps:
        - run: echo "TEST - starting plan step"
        - init
        - plan
    apply:
      steps:
        - run: echo "TEST - starting apply step"
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
      skip_merge_check: true  # Let Dev Apply before the branch is mergable

  prod:
    plan:
      steps:
        - run: echo "PROD - starting plan step"
        - init
        - plan
    apply:
      steps:
        - run: echo "PROD - starting apply step"
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]

  with-checkov:
    plan:
      steps:
        - init
        - plan
        - run: checkov -d . --framework terraform
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]

  with-infracost:
    plan:
      steps:
        - init
        - plan
        - run: infracost breakdown --path=. | tee -a $DIGGER_OUT
        - run: git checkout $DEFAULT_BRANCH && infracost breakdown --path . --format=json --out-file=$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json && git fetch origin $PR_BRANCH && git checkout $PR_BRANCH
        - run: infracost diff --path=. --compare-to=$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json | tee -a $DIGGER_OUT
    apply:
      steps:
        - init
        - apply
    workflow_configuration:
      on_pull_request_pushed: ["digger plan"]
      on_pull_request_closed: ["digger unlock"]
      on_commit_to_default: ["digger unlock"]
